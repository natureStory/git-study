<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <button onclick="register(); return false">nihao</button>
    <script language="other">
        // https://juejin.im/post/5b5d0ac5f265da0f574df709
        function Promise2(executor) {
            const _this = this;
            this.state = 'pending';
            this.value = undefined;
            this.reason = undefined;
            this.onFulfilledFunc = [];
            this.onRejectedFunc = [];
            function resolve(value) {
                if (_this.state === 'pending') {
                    _this.state = 'resolved';
                    _this.value = value;
                    _this.onFulfilledFunc.forEach(fn => fn(_this.value));
                }
            }
            function reject(reason) {
                if (_this.state === 'pending') {
                    _this.state = 'rejected';
                    _this.reason = reason;
                    _this.onRejectedFunc.forEach(fn => fn(_this.reason));
                }
            }
            executor(resolve, reject);
        }
        Promise2.prototype.then = function (onFulfilled, onRejected) {
            onFulfilled = typeof onFulfilled === 'function'?onFulfilled:val=>val;
            onRejected = typeof onRejected === 'function'?onRejected: err=>{throw err};
            let self = this;
            let p2;
            p2 = new Promise2((resolve, reject) => {
                if (this.state === 'pending') {
                    this.onFulfilledFunc.push(() => {
                        try {
                            resolvePromise(p2, onFulfilled(self.value), resolve, reject);
                        } catch (e) {
                            reject(e);
                        }
                    });
                    this.onRejectedFunc.push(() => {
                        try {
                            resolvePromise(p2, onRejected(self.value), resolve, reject);
                        } catch (e) {
                            reject(e);
                        }
                    });
                }
                if (this.state === 'resolved') {
                    try {
                        resolvePromise(p2, onFulfilled(self.value), resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                }
                if (this.state === 'rejected') {
                    try {
                        resolvePromise(p2, onRejected(self.reason), resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                }
            });
            return p2;
        };
        function resolvePromise(p2, x, resolve, reject) {
            debugger
            if(p2 === x){
                return reject(new TypeError('Chaining cycle'));
            }
            if(x!==null && (typeof x=== 'object' || typeof x === 'function')){
                try {
                    let then = x.then;
                    if (typeof then === 'function') {
                        then.call(x, y=> {
                            resolvePromise(p2, y, resolve, reject);
                        }, err => {
                            reject(err);
                        });
                    } else  {
                        resolve(x)
                    }
                } catch (e) {
                    reject(x);
                }
            } else {
                resolve(x);
            }
        }
        let p = new Promise2((resolve)=> {resolve(2)}).then((data)=> {console.log(data);return data;}).then((data)=> {console.log(data);return data;})
        console.log(p);
    </script>

    <script language="text">
        Function.prototype.bind2=function(content, ...arg) {
            let func = this;
            return function() {
                return func.apply(content, [...arg, ...Array.from(arguments)])
            }
        }
        function add(a, b) {
            console.log(this.num);
            console.log(a, b);
            return a +  b;
        }
        let obj = {num: 1}
        var func = add.bind2(obj, 1);
        console.log(func(2));
    </script>
    <script>
        function calc(num, result = []) {
            for (let i = 2; i <= num; i++) {
                if (i !== num) {
                    if (num%i === 0) {
                        result.push(i);
                        return calc(num/i, result);
                    }
                } else {
                    result.push(num);
                    return result;
                }
            }
        }
    </script>
</body>
</html>